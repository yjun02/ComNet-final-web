## 네트워크 계층의 두 가지 임무: Forwarding vs. Routing

네트워크 계층(Network Layer)의 임무는 데이터를 출발지(Source)에서 목적지(Destination)까지 안전하게 보내는 것입니다. 이 임무는 두 가지 역할로 나뉩니다.

### 1. 라우팅 (Routing) - 길 찾기 계획 (Control Plane)

- **비유:** 서울에서 부산까지 가는 **최적의 경로**를 미리 계산하는 것입니다. (내비게이션에 목적지를 입력하는 행위)
- **정의 (Definition):** 패킷이 종단(end-to-end) 경로를 따라갈 **경로(Route)**를 결정하는 네트워크 전반의 (Network-wide) 논리입니다.
- **수행 주체:** **Control Plane** (제어 평면)에 있는 **Routing Processor** (라우팅 프로세서)와 **라우팅 알고리즘**이 담당합니다. 이 결과로 **Forwarding Table**이 만들어집니다.

### 2. 포워딩 (Forwarding) - 즉시 이동 (Data Plane)

- **비유:** 현재 교차로(라우터)에 도착한 차(패킷)를 **어느 출구(출력 포트)**로 내보낼지 **즉시** 결정하고 이동시키는 것입니다. (내비게이션이 '우회전하세요'라고 알려주는 행위)
- **정의 (Definition):** 라우터의 **입력 링크(Input Link)**로 들어온 패킷을 미리 만들어진 **Forwarding Table**을 참고하여 적절한 **출력 링크(Output Link)**로 이동시키는 지역적 (Local, per-router) 기능입니다.
- **수행 주체:** **Data Plane** (데이터 평면)에 있는 **Input Port, Switching Fabric, Output Port**가 담당하며, **하드웨어**로 구현되어 매우 빠르게 동작합니다.

> 핵심: Routing이 큰 그림의 경로를 결정하면 (Control Plane), Forwarding은 그 경로 위에서 실제로 패킷을 옮기는 행동을 합니다 (Data Plane).
> 

---

## 라우터의 내부 구조: 패킷 처리 공장

라우터는 패킷을 고속으로 처리하는 공장과 같습니다.

### 1. 입력 포트 (Input Port)

- **역할:** 패킷이 라우터로 들어오는 문입니다. 링크 계층(Link Layer)에서 프레임(Frame)을 받아 네트워크 계층의 **IP datagram**을 추출합니다.
- **가장 중요한 기능:** **포워딩 테이블 조회 (Lookup)**
    - 패킷의 **목적지 IP 주소**를 확인하여, 미리 만들어진 **Forwarding Table**을 찾습니다.
    - 이 조회를 통해 이 패킷을 어느 **출력 포트(Output Port)**로 보낼지 결정합니다.

### 심화: Longest Prefix Matching (가장 긴 프리픽스 일치)

- 라우팅 테이블에는 목적지 IP 주소 전체가 아닌, **IP 주소의 앞부분 (Prefix)**만 저장됩니다.
- **문제:** 하나의 목적지 IP 주소가 테이블의 여러 Prefix와 일치할 수 있습니다.
    - *예시:* IP 주소 `11001010 00010000 00011000 00010001`
        - 항목 A: `11001010` (8비트 일치) -> 출력 1번
        - 항목 B: `11001010 00010000 00011000` (24비트 일치) -> 출력 2번
- **규칙:** 가장 구체적인 경로를 따라가기 위해, 일치하는 **가장 긴 Prefix**를 가진 항목을 선택합니다. (위 예시에서는 24비트 일치하는 항목 B를 선택)

### 심화: HOL Blocking (Head-of-the-Line Blocking)

- **발생 이유:** 입력 포트 버퍼(Input Buffer)에서 스위칭 패브릭(Switching Fabric)으로 패킷을 보내려고 할 때, 패브릭의 속도나 다른 포트와의 충돌 때문에 지연이 발생할 수 있습니다.
- **현상:** 버퍼의 **가장 앞(Head)**에 있는 패킷이 지연되면, 이 패킷이 **다른 출력 포트로 갈 수 있는** 뒤따르는 패킷들의 이동까지 막아버리는 현상입니다.

### 2. 스위칭 패브릭 (Switching Fabric)

- **역할:** 라우터 내부의 **고속도로**입니다. 입력 포트에서 조회된 패킷을 결정된 출력 포트로 실제로 전달하는 물리적/논리적 경로입니다.
- **종류:**
    1. **Memory를 통한 스위칭:** (구형) 느립니다.
    2. **Bus를 통한 스위칭:** (중형) 버스의 대역폭이 한계가 됩니다.
    3. **Interconnection Network (Crossbar)를 통한 스위칭:** (고성능) 동시에 여러 패킷을 병렬로 처리할 수 있어 가장 빠릅니다.

### 3. 출력 포트 (Output Port)

- **역할:** 스위칭 패브릭을 통해 도착한 패킷을 최종적으로 출력 링크로 내보내기 전에 관리합니다.
- **가장 중요한 기능:** **큐잉 (Queueing) 및 스케줄링 (Scheduling)**
    - **Queueing:** 스위칭 패브릭의 속도 > 출력 링크의 속도일 경우, 패킷이 **Output Buffer**에 쌓입니다. (여기가 라우터에서 패킷 지연과 손실이 발생하는 주요 지점입니다.)
    - **Packet Loss:** 버퍼가 가득 차면, 새로 도착하는 패킷은 버려집니다 (**Drop**).
    

---

## 출력 포트의 핵심: 패킷 스케줄링 (Packet Scheduling)

출력 버퍼에 쌓인 패킷들을 어떤 순서로 출력 링크로 내보낼지 결정하는 정책입니다.

| **정책 (Policy)** | **영어 표현** | **작동 방식** | **특징** |
| --- | --- | --- | --- |
| **선입선출** | **FCFS (First-Come, First-Served)** | 도착한 순서대로 보냅니다. (가장 단순) | 공정하지만, 중요도가 높은 패킷을 먼저 보내지 못합니다. |
| **우선순위 스케줄링** | **Priority Scheduling** | 패킷을 여러 **Class**로 분류하고, 우선순위가 높은 클래스의 큐에 있는 패킷을 먼저 보냅니다. | 중요한 트래픽 (예: VoIP, 게임)에 낮은 지연 시간을 보장합니다. |
| **라운드 로빈** | **Round Robin (RR)** | 큐들을 순환하며, 각 클래스 큐에서 **하나의 완전한 패킷**을 차례로 보냅니다. | 각 클래스에 공평하게 (Fair) 서비스 기회를 제공합니다. |
| **가중치 기반 공평 큐잉** | **WFQ (Weighted Fair Queuing)** | **Round Robin**의 고급 버전입니다. 각 클래스에 **가중치(Weight)**를 할당하여, 가중치에 비례하는 서비스 비율을 보장합니다. | **RR**이 1:1:1로 시간을 나눈다면, **WFQ**는 3:2:1과 같이 중요도에 따라 자원을 분배합니다. |

---

### 인터넷의 서비스 모델: Best Effort (최선 노력)

IP 프로토콜은 패킷 전송에 대해 어떠한 약속도 하지 않습니다. 이것이 바로 **Best Effort Service**입니다.

- **보장 없음 (No Guarantees on):**
    - **성공적인 전달 (Delivery):** 중간에 손실될 수 있습니다.
    - **전달 순서 (Order):** 패킷이 뒤섞여 도착할 수 있습니다.
    - **시간/지연 (Timing):** 도착 시간에 대해 보장하지 않습니다.
    - **대역폭 (Bandwidth):** 사용 가능한 대역폭에 대한 보장이 없습니다.

이처럼 IP 계층은 매우 단순하게 설계되었으며, 부족한 신뢰성이나 순서 보장 등은 상위 계층인 **TCP** (Transmission Control Protocol)가 처리합니다.

---

## DHCP (Dynamic Host Configuration Protocol)

컴퓨터가 네트워크에 접속했을 때, 일일이 수동으로 IP 주소를 입력하는 대신 **자동으로 IP 주소를 할당**받게 해주는 프로토콜입니다.

- **별명**: "Plug-and-play" 프로토콜.
- **주요 역할**: 호스트가 네트워크 서버로부터 IP 주소, 서브넷 마스크, 디폴트 게이트웨이 주소, DNS 서버 주소를 자동으로 얻게 합니다.

### DHCP 작동 4단계 (중요!)

1. **DHCP Discover**: 클라이언트가 "IP 주소 줄 사람?" 하고 브로드캐스트 패킷을 보냅니다.
2. **DHCP Offer**: 서버가 "내가 줄게, 이 주소 어때?" 하고 제안합니다.
3. **DHCP Request**: 클라이언트가 "그 주소 쓸게! 고마워" 하고 확답을 보냅니다.
4. **DHCP ACK**: 서버가 "오케이, 그럼 이제부터 그 주소 써!" 하고 최종 승인합니다.

---

## 계층적 주소 지정 (Hierarchical Addressing)

인터넷의 수많은 주소를 효율적으로 관리하기 위해, 상위 ISP가 하위 ISP나 기관에 큰 주소 블록을 쪼개서 나눠주는 방식입니다. 이를 통해 라우팅 테이블의 크기를 줄이는 **Route Aggregation(라우팅 요약)**이 가능해집니다.

---

## NAT (Network Address Translation)

부족한 IPv4 주소 문제를 해결하기 위한 기술로, **사설 네트워크 안에서는 사설 IP**를 쓰고, **외부 인터넷으로 나갈 때만 하나의 공인 IP**를 공유해서 사용하는 방식입니다.

- **작동 원리**: 라우터가 내부 호스트의 `(사설 IP, 포트 번호)`와 외부의 `(공인 IP, 새로운 포트 번호)`를 매핑하는 **NAT Translation Table**을 관리합니다.
- **장점**:
    - 공인 IP 하나로 수많은 기기 연결 가능.
    - 내부 네트워크 주소를 바꾸지 않고 ISP를 변경 가능.
    - 외부에서 내부 기기에 직접 접근이 어려워 보안상 유리함.
- **논란**: 라우터는 3계층 장비인데 4계층 정보인 포트 번호를 건드린다는 점(Layer violation) 등이 지적되기도 합니다.

---

## IPv6 (Next Generation IP)

32비트인 IPv4 주소가 고갈됨에 따라 등장한 **128비트** 주소 체계입니다.

- **주요 특징**:
    - **고정된 40바이트 헤더**: 처리가 빨라짐.
    - **Fragmentation 금지**: 라우터의 부담을 줄이기 위해 중간 라우터에서는 분할을 하지 않습니다.
    - **Checksum 제거**: 이미 2계층(Link)과 4계층(Transport)에서 검사하므로 속도 향상을 위해 제거되었습니다.
- **Transition (전환 기술)**: IPv4와 IPv6는 서로 직접 통신이 안 되므로, IPv4 네트워크를 통과할 때 IPv6 패킷을 IPv4 패킷 안에 집어넣는 **Tunneling(터널링)** 기술을 주로 사용합니다.

---

## Generalized Forwarding (OpenFlow/SDN)

기존의 라우팅이 '목적지 IP'만 보고 어디로 보낼지 결정했다면, **Generalized Forwarding**은 훨씬 똑똑합니다.

- **Match + Action**: 패킷 헤더의 다양한 필드(MAC 주소, IP 주소, 포트 번호 등)를 조합하여 **Match** 시키고, 그에 맞는 **Action**(전송, 폐기, 헤더 수정 등)을 수행합니다.
- **Flow Table**: 이러한 매칭 규칙들을 모아놓은 표입니다. 이를 통해 라우터 하나가 방화벽, 로드 밸런서, 스위치 등 다양한 역할을 할 수 있게 됩니다.